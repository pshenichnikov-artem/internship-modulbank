# AccountService — Сервис управления банковскими счетами и транзакциями

---

## Описание проекта

**AccountService** — микросервис для управления банковскими счетами и транзакциями. Предоставляет API для создания, обновления, удаления счетов и управления транзакциями.

---

## Технологии

- .NET 9 / ASP.NET Core  
- Entity Framework Core (EF Core)  
- MediatR
- FluentValidation  
- AutoMapper  
- Swagger/OpenAPI  
- PostgreSQL с потокобезопасными транзакциями
- Hangfire для фоновых задач
- Messaging Library для асинхронных сообщений
- RabbitMQ для обмена сообщениями
- XUnit

---

## Архитектура

- **Features** — бизнес-логика по функциональным модулям (Accounts, Transactions)  
- **Common** — общие модели, интерфейсы, утилиты  
- **Infrastructure** — взаимодействие с базой данных и внешними системами  

---

## Основная функциональность

### Асинхронные сообщения

Сервис отправляет события через RabbitMQ с использованием **Outbox Pattern** для гарантированной доставки:

#### События счетов
- **AccountOpened** (`account.opened`) - открытие нового счета
- **AccountClosed** (`account.closed`) - закрытие счета
- **AccountUpdated** (`account.updated`) - обновление параметров счета
- **InterestAccrued** (`interest.accrued`) - начисление процентов по депозиту

#### События транзакций
- **MoneyCredited** (`money.credited`) - пополнение счета
- **MoneyDebited** (`money.debited`) - списание со счета
- **MoneyTransfer** (`money.transfer`) - перевод между счетами
- **TransactionCanceled** (`transaction.canceled`) - отмена транзакции
- **TransactionUpdated** (`transaction.updated`) - обновление транзакции

#### События клиентов
- **ClientBlocked** (`client.blocked`) - блокировка клиента (заморозка всех счетов)
- **ClientUnblocked** (`client.unblocked`) - разблокировка клиента

#### Обработка входящих сообщений
Сервис также **потребляет** события блокировки клиентов через **AntifraudConsumer**:
- При получении `client.blocked` - замораживает все счета клиента
- При получении `client.unblocked` - размораживает все счета клиента

#### Надежность доставки
- **Outbox Pattern** - все исходящие события сначала сохраняются в БД, затем отправляются
- **Inbox Pattern** - защита от дублирования входящих сообщений
- **Retry механизм** - 10 попыток обработки с экспоненциальной задержкой
- **Dead Letter Queue** - сообщения, которые не удалось обработать, сохраняются для анализа

### Управление счетами

- Создание счетов разных типов: кредитный, депозитный, расчетный  
- Получение информации о счетах с фильтрацией, пагинацией и сортировкой  
- Обновление и частичное изменение параметров счета  
- Закрытие и удаление счетов

### Управление транзакциями

- Создание транзакций: пополнение (Credit), списание (Debit), перевод (Transfer)  
- Отмена транзакций с проверкой балансов и целостности данных  
- Получение истории транзакций с фильтрацией и пагинацией  
- Обновление описаний транзакций  

---

## Бизнес-правила и ограничения

- **Переводы (Transfer) с депозитного счета запрещены.**  
- **Депозитный и расчетный счета не могут иметь отрицательный баланс.**  
- **Кредитный счет допускает уход в минус.**  
- При переводах деньги списываются с контрагента (`CounterpartyAccountId`) и зачисляются на основной счет (`AccountId`).  
- Владелец операции должен совпадать с владельцем счета, с которого списываются средства (для переводов — контрагент).  
- Валюты конвертируются при необходимости, однако текущая реализация содержит жестко заданный (захардкоженный) механизм конвертации между валютами.  

---

## Описание процесса транзакций

- Каждая транзакция запускается в рамках транзакции базы данных для обеспечения атомарности.  
- Перед проведением операции проверяется принадлежность счетов пользователю по `OwnerId`.  
- Валидируется поддержка валют транзакции и счетов.  
- Для операций пополнения/списания изменяется баланс одного счета, с учетом бизнес-правил.  
- Для переводов изменяются балансы двух счетов с учетом конвертации валют.  
- Отправляется соответствующее событие в Outbox (`MoneyCredited`, `MoneyDebited` или `TransferCompleted`).  
- При ошибках изменения откатываются.  
- Отмена транзакций восстанавливает балансы с обратной логикой, помечая транзакцию как отменённую.  

---

## API Endpoints (Кратко)

### Счета (Accounts)

| Метод  | URL                                 | Описание                 |
| ------ | ----------------------------------- | ------------------------ |
| POST    | `/api/v1/accounts/search`           | Получить список счетов   |
| GET    | `/api/v1/accounts/{id}`             | Получить счет по ID      |
| POST   | `/api/v1/accounts`                  | Создать новый счет       |
| PUT    | `/api/v1/accounts/{id}`             | Обновить счет полностью  |
| PATCH  | `/api/v1/accounts/{id}/{fieldName}` | Обновить отдельное поле  |
| DELETE | `/api/v1/accounts/{id}`             | Удалить или закрыть счет |


### Транзакции (Transactions)

| Метод | URL                                | Описание                       |
| ----- | ---------------------------------- | ------------------------------ |
| POST  | `/api/v1/transactions/search`      | Поиск транзакций с фильтрацией |
| GET   | `/api/v1/transactions/{id}`        | Получить транзакцию по ID      |
| POST  | `/api/v1/transactions`             | Создать новую транзакцию       |
| PUT   | `/api/v1/transactions/{id}`        | Обновить описание транзакции   |
| POST  | `/api/v1/transactions/{id}/cancel` | Отменить транзакцию            |


---

## Фоновые задачи

**Hangfire** используется для выполнения фоновых задач:
- **Начисление процентов по депозитам** — автоматически выполняется каждый день в 2:00 ночи
- Задача обрабатывает все активные депозитные счета и начисляет проценты согласно установленной процентной ставке
- Логика реализована посредством хранимой процедуры

**Фоновые сервисы (Background Services):**
- **OutboxDispatcherService** — автоматически отправляет сообщения из Outbox в RabbitMQ каждые 30 секунд
- **AntifraudConsumer** — обрабатывает события блокировки/разблокировки клиентов из очереди `account.antifraud`
- **AuditConsumer** — сохраняет все события системы в таблицу аудита из очереди `account.audit`

---

## Потокобезопасность и надежность

- PostgreSQL с `xmin` (row-level versioning) для предотвращения конфликтов параллелизма  
- Использование блокировок `FOR UPDATE` при изменении балансов
- **Outbox Pattern** для гарантированной доставки сообщений
- **Inbox Pattern** для защиты от дублирования сообщений
- **Корреляция запросов** для отслеживания сквозных операций

---

## Миграции БД

Библиотека автоматически добавляет необходимые таблицы через `modelBuilder.AddMessagingEntities()`:
- `outbox_messages` - исходящие сообщения
- `inbox_consumed` - обработанные сообщения
- `inbox_dead_letters` - ошибочные сообщения
- `audit_events` - аудит событий

---

## Важные замечания

- Правила списания и зачисления строго зависят от типа счета и транзакции.  
- Переводы с депозитного счета запрещены.  
- Поддержка мультивалютности есть, но конвертация валют реализована статично и требует доработки для реальной работы с курсами.  
- Все операции с балансами выполняются в рамках транзакций базы данных для обеспечения целостности данных.

---